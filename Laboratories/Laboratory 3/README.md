# Laboratory 3

# Databases Pt. 1

## Connect a Database to the Project

### Adding a Database Controller

1. Right-click on the `Controllers` folder
2. Select **Add** > **Controller...** from the context menu.
3. Choose **API Controller - Empty**
4. Name the new controller file `DatabaseController.cs`

### Adding the Context

1. Right-click on `Lab3_24`
2. Select **Add** > **New Folder**, then name it `Data`
3. Right-click on `Data`
4. Select **Add** > **Class...**, then name it `Lab3Context.cs`

### Adding the Packages

1. Right-click on `Solution Lab3_24`
2. Select **Manage NuGet Packages for Solution...**
3. Select **Browse**, then install the following:
   - `Microsoft.EntityFrameworkCore`
   - `Microsoft.EntityFrameworkCore.SqlServer`
   - `Microsoft.EntityFrameworkCore.Tools`
   - `Microsoft.EntityFrameworkCore.Relational`

---

## Writing the Context

In `Lab3Context.cs`:

```csharp
using Microsoft.EntityFrameworkCore;

namespace Lab3_24.Data
{
    public class Lab3Context: DbContext
    {
        public Lab3Context(DbContextOptions<Lab3Context> options) : base(options) { }

        protected override void OnModelCreating(ModelBuilder modelBuilder) { }
    }
}
```

### :bulb: `DbContext` is a base class provided by Entity Framework Core that manages the database connections and is used to configure the model and query the database.

### :star: Explaining the Constructor:

```csharp
public Lab3Context(DbContextOptions<Lab3Context> options) : base(options) { }
```

- This is the constructor of the Lab3Context class. It takes an argument of type DbContextOptions<Lab3Context>, which contains configuration settings for the DbContext like connection strings and database provider details.
- The : base(options) part calls the base class constructor (DbContext) with the provided options, ensuring that the base class is properly initialized with the configuration.

### :star: Explaining the OnModelCreating Method:

```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    // Method body
}
```

- This method is overridden from the base `DbContext` class.
- `OnModelCreating` is used to configure the model that Entity Framework uses to create the database. Typically, this method includes code to configure entity properties and relationships using Fluent API.

---

### Adding the Interface

1. Right-click on `Lab3_24`
   - Select **Add** > **New Folder**, then name it `Models`
2. Right-click on `Models`
   - Select **Add** > **New Folder**, then name it `Base`
3. Right-click on `Base`
   - Select **Add** > **Class...**, then name it `BaseEntity.cs`
   - Select **Add** > **Class...** > **Interface**, then name it `IBaseEntity.cs`

---

## Implementing the Interface

In `IBaseEntity.cs`:

```csharp
namespace Lab3_24.Models.Base
{
    public interface IBaseEntity
    {
        Guid Id { get; set; }

        DateTime? DateCreated { get; set; }
        DateTime? DateModified { get; set; }
    }
}

```

### :bulb: An interface in C# is a contract or a blueprint for a class, specifying what properties, methods, or events it must implement but not how they should be implemented.

### :bulb: The naming convention of starting the interface name with "I" is a common practice in C# to indicate that it's an interface.

### :star: Explaining the Properties:

```csharp
Guid Id { get; set; }
```

- This property represents a unique identifier for the entity.
- The Guid (Globally Unique Identifier) type is often used for IDs in databases.
- The { get; set; } syntax means this property is readable and writable.

```csharp
DateTime? DateCreated { get; set; }
DateTime? DateModified { get; set; }
```

- This property is meant to store the date and time when the entity was created/ modified.
- The `DateTime?` type indicates a nullable DateTime, meaning it can hold a DateTime value or be null.

---

## Implementing the BaseEntity

In `BaseEntity.cs`:

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Lab3_24.Models.Base
{
    public class BaseEntity: IBaseEntity
    {
        [Key]
        // Generates a value when a row is inserted
        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]

        // Generates a value when a row is inserted or updated
        //[DatabaseGenerated(DatabaseGeneratedOption.Computed)]
        //[DatabaseGenerated(DatabaseGeneratedOption.None)]

        public Guid Id { get; set; }
        public DateTime? DateCreated { get; set; }
        public DateTime? DateModified { get; set;}
    }
}
```

### :bulb: `BaseEntity.cs` must define the properties defined in `IBaseEntity.cs`.

### :star: Explaining the Database Attributes:

```csharp
[Key]
```

- This attribute specifies that the Id value should be generated by the database when a new record is inserted. DatabaseGeneratedOption.Identity indicates that the database should generate a unique value (usually an auto-incrementing number or a GUID).
- An attribute indicating that the `Id` property is the primary key in the database table.

```csharp
[DatabaseGenerated(DatabaseGeneratedOption.Identity)]
```

- This attribute specifies that the `Id` value should be generated by the database when a new record is inserted. `DatabaseGeneratedOption.Identity` indicates that the database should generate a unique value (usually an auto-incrementing number or a GUID).

```csharp
//[DatabaseGenerated(DatabaseGeneratedOption.Computed)]
//[DatabaseGenerated(DatabaseGeneratedOption.None)]
```

- They are alternative options for the `DatabaseGenerated` attribute:
  - `DatabaseGeneratedOption.Computed`: Indicates that the value is generated by the database on insert and update operations.
  - `DatabaseGeneratedOption.None`: Indicates that the value is not generated by the database automatically.

---

### Adding the Model

Right-click on `Models`

- Select **Add** > **Class...**, then name it `Student.cs`

In `Student.cs`:

```csharp
using Lab3_24.Models.Base;

namespace Lab3_24.Models
{
    public class Student: BaseEntity
    {
        public string? Name { get; set; }
        public int Age { get; set; }
    }
}
```

### :bulb: We must add our model in `Lab3Context.cs`.

```csharp
public DbSet<Student> Students { get; set; }
```

### :bulb: `DbSet<T>` is a generic type provided by Entity Framework Core. It represents a collection of entities of a specific type that you can query and save.

### :bulb: One C# naming convention is using a plural name for collections. By convention, it's also the name that Entity Framework Core will use when creating the corresponding table in the database, unless configured otherwise.

---

### Making the Database Connection

It's best to use **Microsoft SQL Server Management Studio**.
| Properties | Values |
|---|---|
| Server type | Database Engine |
| Server name | (this depends) |
| Authentication | Windows Authentication |

1. Double-click on your **Server name**
2. Right-click on **Databases**
3. Select **New Database**, then name it

### :bulb: You can see your Database in Visual Studio. Press View > SQL Server Object Explorer.

### :bulb: Browse until you find the name of your Database and Right-click on Properties. To show all Properties, expand your database.

In the **Properties** tab, search for **Connection string**, then copy it.

In the `appsettings.json` add the Connection:

```json
  "ConnectionStrings": {
    "DbConnection": "<your Connection string>"
  }
```

### :bulb: Append to your Connection string `MultipleActiveResultSets=true` to enable the execution of multiple queries using the same database connection.

Copy the same Connection code to `appsettings.Development.json`.

In `Program.cs` we will tell our application where to take the connection from:

```csharp
// Add Services to the container.

// other services...

builder.Services.AddDbContext<Lab3Context>(
    options => options.UseSqlServer(builder.Configuration.GetConnectionString("DbConnection")));
```

---

### Adding the Migration

We are going to use the Visual Studio terminal (**Package Manager Console**):

`PM> Add-Migration <Appropiate Name>`

### :bulb: After the command was succesfully executed, you will see a folder named `Migrations`. **Never** delete the migrations from there, only from the terminal!

After adding the migration, you have to update the database with the command:

`PM> update-database`

There will be a lot of SQL code and alongside it the Student Table:

```sql
CREATE TABLE [Students] (
    [Id] uniqueidentifier NOT NULL,
    [Name] nvarchar(max) NULL,
    [Age] int NOT NULL,
    [DateCreated] datetime2 NULL,
    [DateModified] datetime2 NULL,
    CONSTRAINT [PK_Students] PRIMARY KEY ([Id])
);
```

### Adding a Value in the Table

In **Microsoft SQL Server Management Studio** > "YourServerName" > Databases > "YourDatabaseName" > **dbo.Students**, Right-click on **dbo.Students** > Select Top 1000 Rows.

Execute the following code:

```sql
INSERT INTO [students] (Id, DateCreated, DateModified, Name, Age)
VALUES (NEWID(), GETDATE(), GETDATE(), 'Test1', 24);
```

### Using the Database Controller

We will use the Context to take values.

Complete the code in `DatabaseController.cs`:

```csharp
using Lab3_24.Data;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace Lab3_24.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class DatabaseController : ControllerBase
    {
        private readonly Lab3Context _lab3Context;

        public DatabaseController(Lab3Context lab3Context)
        {
            _lab3Context = lab3Context;
        }

        [HttpGet]
        public async Task<IActionResult> Get()
        {
            return Ok(await _lab3Context.Students.ToListAsync());
        }
    }
}
```

Run the Application and then Try out the `/api/Database` to see the values in the **Response body**.

```json
[
  {
    "name": "Test1",
    "age": 24,
    "id": "77ae3c95-9d6f-40f7-a2dc-1f5ceca11772",
    "dateCreated": "2023-12-18T15:49:33.8833333",
    "dateModified": "2023-12-18T15:49:33.8833333"
  }
]
```

## :link: Resources

- https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/linq/-basic-linq-query-operations
- https://www.entityframeworktutorial.net/efcore/fluent-api-in-entity-framework-core.aspx
- https://www.entityframeworktutorial.net/code-first/what-is-code-first.aspx
- https://www.entityframeworktutorial.net/efcore/entity-framework-core-migration.aspx
